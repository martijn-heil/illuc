<div class="app-shell">
    <header class="titlebar" data-tauri-drag-region>
        <div class="titlebar-spacer" data-tauri-drag-region></div>
        <div class="titlebar-controls">
            <button
                type="button"
                class="titlebar-button"
                (click)="minimizeWindow()"
                aria-label="Minimize"
                data-tauri-drag-region="false"
            >
                <svg
                    class="titlebar-icon"
                    viewBox="0 0 10 10"
                    aria-hidden="true"
                >
                    <line x1="2" y1="7.5" x2="8" y2="7.5"></line>
                </svg>
            </button>
            <button
                type="button"
                class="titlebar-button"
                (click)="toggleMaximizeWindow()"
                aria-label="Maximize"
                data-tauri-drag-region="false"
            >
                <svg
                    *ngIf="!isMaximized"
                    class="titlebar-icon"
                    viewBox="0 0 10 10"
                    aria-hidden="true"
                >
                    <rect x="2" y="2" width="6" height="6"></rect>
                </svg>
                <svg
                    *ngIf="isMaximized"
                    class="titlebar-icon"
                    viewBox="0 0 10 10"
                    aria-hidden="true"
                >
                    <rect x="3" y="2" width="5" height="5"></rect>
                    <rect x="2" y="3" width="5" height="5"></rect>
                </svg>
            </button>
            <button
                type="button"
                class="titlebar-button close"
                (click)="closeWindow()"
                aria-label="Close"
                data-tauri-drag-region="false"
            >
                <svg
                    class="titlebar-icon"
                    viewBox="0 0 10 10"
                    aria-hidden="true"
                >
                    <line x1="2.5" y1="2.5" x2="7.5" y2="7.5"></line>
                    <line x1="7.5" y1="2.5" x2="2.5" y2="7.5"></line>
                </svg>
            </button>
        </div>
    </header>
    <main class="content">
        <app-task-sidebar
            *ngIf="baseRepo() as repo"
            [tasks]="tasks()"
            [selectedTaskId]="taskStore.selectedTaskId()"
            [baseRepo]="repo"
            [stopLoadingIds]="stoppingTasks()"
            (createTask)="openCreateTaskModal()"
            (selectTask)="selectTask($event)"
            (stopTask)="stopTask($event)"
            (discardTask)="discardTask($event)"
        ></app-task-sidebar>

        <app-task-view
            class="task-view"
            [task]="selectedTask()"
            [baseRepo]="baseRepo()"
            [startLoading]="isStartingTask(selectedTask()?.taskId)"
            [stopLoading]="isStoppingTask(selectedTask()?.taskId)"
            [selectRepoLoading]="isSelectingRepo"
            (startTask)="startTask($event)"
            (stopTask)="stopTask($event)"
            (discardTask)="discardTask($event)"
            (selectBaseRepo)="browseForRepo()"
        ></app-task-view>
    </main>

    <footer class="status-bar" *ngIf="baseRepo()">
        <ng-container
            *ngIf="selectedTask() as currentTask; else statusPlaceholder"
        >
            <span class="status-meta">
                Branch: <strong>{{ currentTask.branchName }}</strong> •
                Worktree:
                <a
                    href="#"
                    class="path-link"
                    (click)="openInExplorer($event, currentTask.worktreePath)"
                    [attr.title]="currentTask.worktreePath"
                >
                    {{ currentTask.worktreePath }}
                </a>
            </span>
        </ng-container>
        <ng-template #statusPlaceholder>
            <span class="status-meta status-placeholder"
                >Select a task to see branch and worktree details.</span
            >
        </ng-template>
    </footer>

    <div class="modal-backdrop" *ngIf="showCreateModal">
        <div class="modal">
            <h3>Create Task</h3>
            <p class="modal-subtitle">
                Provide the Git branch name for this task.
            </p>
            <label class="input-label">Branch name</label>
            <input
                type="text"
                [(ngModel)]="branchNameInput"
                placeholder="e.g. feature/25323-fancy-feature-name"
            />
            <label class="input-label">Base branch</label>
            <div class="select-wrapper">
                <select [(ngModel)]="baseBranchSelection">
                    <option
                        *ngIf="
                            baseBranchSelection &&
                            branchOptions().indexOf(baseBranchSelection) === -1
                        "
                        [value]="baseBranchSelection"
                    >
                        {{ baseBranchSelection }}
                    </option>
                    <option
                        *ngFor="let branch of branchOptions()"
                        [value]="branch"
                    >
                        {{ branch }}
                    </option>
                </select>
                <span class="select-arrow">⌄</span>
            </div>
            <div class="error" *ngIf="branchNameError">
                {{ branchNameError }}
            </div>
            <div class="modal-actions">
                <app-loading-button
                    buttonType="button"
                    buttonClass="ghost"
                    [disabled]="isCreatingTask"
                    (action)="closeCreateTaskModal()"
                >
                    Cancel
                </app-loading-button>
                <app-loading-button
                    buttonType="button"
                    buttonClass="primary"
                    [loading]="isCreatingTask"
                    (action)="submitNewTask()"
                >
                    Create Task
                </app-loading-button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" *ngIf="confirmDiscardTaskId">
        <div class="modal">
            <h3>Discard task?</h3>
            <p class="modal-subtitle">
                This will remove the worktree and discard all changes for
                <strong>{{ confirmDiscardTitle }}</strong>
                <span *ngIf="confirmDiscardBranch"
                    >({{ confirmDiscardBranch }})</span
                >. This action cannot be undone.
            </p>
            <div class="error" *ngIf="confirmDiscardError">
                {{ confirmDiscardError }}
            </div>
            <div class="modal-actions">
                <app-loading-button
                    buttonType="button"
                    buttonClass="ghost"
                    [disabled]="isDiscardingTask"
                    (action)="cancelDiscardTask()"
                >
                    Cancel
                </app-loading-button>
                <app-loading-button
                    buttonType="button"
                    buttonClass="primary warn"
                    [loading]="isDiscardingTask"
                    (action)="confirmDiscardTask()"
                >
                    Discard
                </app-loading-button>
            </div>
        </div>
    </div>
</div>
